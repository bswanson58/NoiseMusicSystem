<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
	 xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension">

	<!-- To update for the next release increment ProductVersion in Version.wxi -->
	<?include ..\Common Files\Version.wxi?>

	<?define ProductName="Noise Music Desktop"?>
	<?define ShortcutRegistryKey="$(var.BaseRegistryKey)\$(var.Noise.Desktop.Platform)\NoiseDesktop"?>

	<Product Id="*"
					 Name="$(var.ProductName)"
					 Language="1033"
					 Version="$(var.ProductVersion)"
					 Manufacturer="$(var.Manufacturer)"
					 UpgradeCode="$(var.ProductUpgradeCode)">
		<Package InstallerVersion="300"
						 Platform="$(var.Noise.Desktop.Platform)"
						 InstallScope="perMachine"
						 InstallPrivileges="elevated"
						 Compressed="yes" />
		
		<MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed. Setup will now exit."/>

		<PropertyRef Id="NETFRAMEWORK45" />
		<Condition Message="This application requires .NET Framework version 4.5. Please install the .NET Framework and then run this installer again.">
			<![CDATA[Installed OR NETFRAMEWORK45]]>
		</Condition>

		<Media Id="1" Cabinet="ApplicationFiles.cab" EmbedCab="yes" />

		<!-- Folder Locations -->
		<?if $(var.Noise.Desktop.Platform) = "x64" ?>
		<?define ProgramFolder="ProgramFiles64Folder"?>
		<?else ?>
		<?define ProgramFolder="ProgramFilesFolder"?>
		<?endif ?>
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="$(var.ProgramFolder)">
				<Directory Id="CompanyDirectory" Name="Secret Squirrel Software">
					<Directory Id="CommonDirectory" Name="Noise Music System">
						<Directory Id="INSTALLDIRECTORY" Name="Noise Desktop" />
					</Directory>
				</Directory>
			</Directory>

			<Directory Id="ProgramMenuFolder">
				<Directory Id="CompanyMenuFolder" Name="Secret Squirrel Software">
					<Directory Id="ProductMenuFolder" Name="Noise Music System" />
					<Component Id='NoiseMenuFolder' Guid="9be688f6-1b67-4208-b379-68c1cb611e32">
						<RemoveFolder Id='NoiseMenuFolder' On='uninstall'/>
						<RegistryValue Root="HKCU" Key="$(var.ShortcutRegistryKey)\NoiseMenuFolder" Name="installed" Type="integer" Value="1" KeyPath="yes" />
					</Component>
				</Directory>
			</Directory>

			<Directory Id="CommonAppDataFolder">
				<Directory Id="ProductDataFolder" Name="Secret Squirrel Software">
					<Directory Id="ProductFolder" Name="Noise Music System">
						<Directory Id="ProductConfigFolder" Name="Configuration" />
					</Directory>
				</Directory>
			</Directory>

			<Directory Id="DesktopFolder" Name="Desktop"/>
		</Directory>

		<!-- Installed Files -->
		<DirectoryRef Id="INSTALLDIRECTORY">
			<Component Id="Noise.Desktop.exe" Guid="df0e902d-7c40-4518-b7fb-1c9059a94713">
				<File Id="Noise.Desktop.exe" DiskId="1" Source="$(var.Noise.Desktop.TargetPath)" KeyPath="yes" Checksum="yes" >
					<fire:FirewallException Id="Desktop.Firewall.Exception" Name="Noise Music System Desktop" Description="Noise Music System support for remote clients."
											Port="71" Protocol="tcp" Scope="localSubnet" />
				</File>
			</Component>

			<Component Id="Noise.Desktop.config" Guid="49b5433a-a532-4d5c-86b9-632f60befe01">
				<File Id="Noise.Desktop.config" DiskId="1" Source="$(var.Noise.Desktop.TargetDir)Noise.Desktop.exe.config" KeyPath="yes" Checksum="yes" />
			</Component>

			<Component Id="Noise.UI.Style.dll" Guid="3c616b69-2034-4242-af37-71de5b4bd13b">
				<File Id="Noise.UI.Style.dll" DiskId="1" Source="$(var.Noise.UI.Style.TargetDir)Noise.UI.Style.dll" KeyPath="yes" Checksum="yes" />
			</Component>

			<!-- Screen Layouts -->
			<Directory Id="UiLayoutConfig" Name="Layouts">
				<Component Id="LayoutConfiguration.xaml" Guid="a75c8e62-b6da-4115-b3b7-c5c4c157f0d8">
					<File Id="LayoutConfiguration.xaml" DiskId="1" Source="$(var.Noise.Desktop.ProjectDir)\Layouts\LayoutConfiguration.xaml" KeyPath="yes" Checksum="yes" />
				</Component>
				<Component Id="ExploreLayout.xaml" Guid="7d7c0259-f984-4bb5-b226-ae2fee70a89d">
					<File Id="ExploreLayout.xaml" DiskId="1" Source="$(var.Noise.Desktop.ProjectDir)\Layouts\ExploreLayout.xaml" KeyPath="yes" Checksum="yes" />
				</Component>
				<Component Id="ListenLayout.xaml" Guid="990f43b1-8c77-4212-ab4d-bf8e106deeb4">
					<File Id="ListenLayout.xaml" DiskId="1" Source="$(var.Noise.Desktop.ProjectDir)\Layouts\ListenLayout.xaml" KeyPath="yes" Checksum="yes" />
				</Component>
				<Component Id="TimeExplorerLayout.xaml" Guid="d891860b-5151-40db-9b72-f3766955d3f2">
					<File Id="TimeExplorerLayout.xaml" DiskId="1" Source="$(var.Noise.Desktop.ProjectDir)\Layouts\TimeExplorerLayout.xaml" KeyPath="yes" Checksum="yes" />
				</Component>
				<Component Id="StartupLayout.xaml" Guid="71e37f9d-5be7-4d76-893c-fe7b73bf1851">
					<File Id="StartupLayoutLayout.xaml" DiskId="1" Source="$(var.Noise.Desktop.ProjectDir)\Layouts\StartupLayout.xaml" KeyPath="yes" Checksum="yes" />
				</Component>
				<Component Id="LibraryCreation.xaml" Guid="5938115d-6e14-4426-938a-01175af44361">
					<File Id="LibraryCreation.xaml" DiskId="1" Source="$(var.Noise.Desktop.ProjectDir)\Layouts\LibraryCreation.xaml" KeyPath="yes" Checksum="yes" />
				</Component>
				<Component Id="LibrarySelection.xaml" Guid="cfaf8ddf-c0b0-4c4d-a3f9-c6d6fe1b9339">
					<File Id="LibrarySelection.xaml" DiskId="1" Source="$(var.Noise.Desktop.ProjectDir)\Layouts\LibrarySelection.xaml" KeyPath="yes" Checksum="yes" />
				</Component>
			</Directory>
		</DirectoryRef>

		<!-- Shortcuts -->
		<DirectoryRef Id="ProductMenuFolder">
			<Component Id="ApplicationShortcut" Guid="d18cbb35-ec2b-455d-999b-3959a2ab8305">
				<Shortcut Id="ApplicationStartMenuShortcut" Name="Noise Music" Description="Noise Desktop Application" Target="[INSTALLDIRECTORY]Noise.Desktop.exe" WorkingDirectory="INSTALLDIRECTORY" />
				<RemoveFolder Id="ApplicationShortcut" On="uninstall" />
				<RegistryValue Root="HKCU" Key="$(var.ShortcutRegistryKey)\ApplicationShortcut" Name="installed" Type="integer" Value="1" KeyPath="yes" />
			</Component>
		</DirectoryRef>

		<DirectoryRef Id="DesktopFolder">
			<Component Id="DesktopShortcut" Guid="3645e7ce-d910-40fe-8ba9-ed1b8592a341">
				<Shortcut Id="DesktopShortcut" Name="Noise Music" Description="Noise Music Desktop Application" Target="[INSTALLDIRECTORY]Noise.Desktop.exe" WorkingDirectory="INSTALLDIRECTORY" />
				<RemoveFolder Id="DesktopShortcut" On="uninstall" />
				<RegistryValue Root="HKCU" Key="$(var.ShortcutRegistryKey)\DesktopShortcut" Name="installed" Type="integer" Value="1" KeyPath="yes" />
			</Component>
		</DirectoryRef>

		<Icon Id="AddRemoveProgramsIcon" SourceFile="$(var.Noise.Desktop.ProjectDir)..\Common\Noise.ico" />
		<Property Id="ARPPRODUCTICON" Value="AddRemoveProgramsIcon" />

		<ComponentGroup Id="ApplicationFiles">
			<ComponentRef Id="Noise.Desktop.exe" />
			<ComponentRef Id="Noise.Desktop.config" />
			<ComponentRef Id="Noise.UI.Style.dll"/>
			<ComponentRef Id="LayoutConfiguration.xaml"/>
			<ComponentRef Id="ExploreLayout.xaml"/>
			<ComponentRef Id="ListenLayout.xaml"/>
			<ComponentRef Id="TimeExplorerLayout.xaml"/>
			<ComponentRef Id="StartupLayout.xaml"/>
			<ComponentRef Id="LibraryCreation.xaml"/>
			<ComponentRef Id="LibrarySelection.xaml"/>
			<ComponentRef Id="ApplicationShortcut" />
			<ComponentRef Id="DesktopShortcut"/>
			<ComponentRef Id="NoiseMenuFolder" />
		</ComponentGroup>

		<Feature Id="Complete" Title="Noise Desktop Install" Level="1" ConfigurableDirectory="INSTALLDIRECTORY">
			<Feature Id="Application" Title="Noise Desktop Application" Level="1">
				<ComponentGroupRef Id="ApplicationFiles" />
				<ComponentGroupRef Id="CoreFiles"/>
				<ComponentGroupRef Id="AutomapperFiles"/>
				<ComponentGroupRef Id="BassAudioFiles"/>
				<ComponentGroupRef Id="CaliburnMicroFiles"/>
				<ComponentGroupRef Id="ConfigurationFiles"/>
				<ComponentGroupRef Id="CuttingEdgeFiles"/>
				<ComponentGroupRef Id="EntityFrameworkFiles"/>
				<ComponentGroupRef Id="GDataDBFiles"/>
				<ComponentGroupRef Id="GongSolutionsFiles"/>
				<ComponentGroupRef Id="LastFmSharpFiles"/>
				<ComponentGroupRef Id="LuceneFiles"/>
				<ComponentGroupRef Id="MahAppsMetroFiles"/>
				<ComponentGroupRef Id="MicrosoftFiles"/>
				<ComponentGroupRef Id="NewtonsoftJsonFiles"/>
				<ComponentGroupRef Id="NLogFiles"/>
				<ComponentGroupRef Id="ObservalFiles"/>
				<ComponentGroupRef Id="PrismFiles"/>
				<ComponentGroupRef Id="RavenDBFiles"/>
				<ComponentGroupRef Id="ReclsFiles"/>
				<ComponentGroupRef Id="ReplayGainFiles"/>
				<ComponentGroupRef Id="StatelessFiles"/>
				<ComponentGroupRef Id="TagLibSharpFiles"/>
			</Feature>
		</Feature>

		<Feature Id="UnnecessaryFiles" Title="Unnecessary Files" Level="0">
			<ComponentGroupRef Id="DotNetZipFiles"/>
		</Feature>

		<UIRef Id="InstallUI" />
		
		<!-- Custom action to set WCF namespace reservation -->
		<CustomAction Id="ListenerServiceAddReservation" Execute="deferred" Return="asyncWait" Directory="INSTALLDIRECTORY"
					  ExeCommand='[SystemFolder]netsh.exe http add urlacl url=http://+:71/Noise user="NT AUTHORITY\Authenticated Users"' />
		
		<CustomAction Id="ListenerServiceDeleteReservation" Execute="deferred" Return="asyncWait" Directory="INSTALLDIRECTORY"
					  ExeCommand="[SystemFolder]netsh.exe http delete urlacl url=http://+:71/Noise" />
		
		<InstallExecuteSequence>        
			<Custom Action="ListenerServiceAddReservation" Before="InstallFinalize">NOT Installed</Custom>
			<Custom Action="ListenerServiceDeleteReservation" Before="InstallFinalize">Installed</Custom>
		</InstallExecuteSequence>

	</Product>
</Wix>
